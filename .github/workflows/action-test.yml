# see https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency
# concurrency:
#   group: "${{ github.workflow }}-${{ github.ref }}"
#   cancel-in-progress: true

name: Run Baseline Scanner
on:
  workflow_dispatch:

jobs:
  baseline:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Get token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get_token
        with:
          app-id: ${{ vars.OSPS_SCANNER_APP_ID }}
          private-key: ${{ secrets.OSPS_SCANNER_APP_PRIVATE_KEY }}

      - name: Baseline Scanner
        id: scan
        uses: revanite-io/pvtr-runner@main # TODO: pin this
        with:
          REPO_OWNER: eddie-knight
          REPO_NAME: pvtr-runner-test
          GH_TOKEN: ${{ steps.get_token.outputs.token }}


      - name: Validate and fix SARIF file
        id: fix_sarif
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          ./validate-sarif.sh "${{ steps.scan.outputs.sarif_file }}"

      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation_results
          path:  ${{ steps.fix_sarif.outputs.sarif_file }}
          if-no-files-found: warn

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.fix_sarif.outputs.sarif_file }}
          category: OSPS Baseline
